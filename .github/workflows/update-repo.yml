name: Update APT Repository

on:
  repository_dispatch:
    types:
      - deb-published
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-apt:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install reprepro and gnupg
        run: |
          sudo apt-get update
          sudo apt-get install -y reprepro gnupg

      - name: Validate payload
        env:
          DEB_URL: ${{ github.event.client_payload.deb_url }}
          DEB_FILENAME: ${{ github.event.client_payload.deb_filename }}
          DISTRO: ${{ github.event.client_payload.distro }}
          COMPONENT: ${{ github.event.client_payload.component }}
        run: |
          test -n "$DEB_URL"
          test -n "$DEB_FILENAME"
          test -n "$DISTRO"
          test -n "$COMPONENT"

      - name: Prepare APT repo config
        env:
          DISTRO: ${{ github.event.client_payload.distro }}
          COMPONENT: ${{ github.event.client_payload.component }}
          ARCH: ${{ github.event.client_payload.architecture }}
        run: |
          mkdir -p repo/conf repo/incoming
          cat > repo/conf/distributions <<EOC
          Origin: JKLabs
          Label: JKLabs APT
          Suite: stable
          Codename: stable
          Architectures: amd64
          Components: main
          Description: JKLabs Debian Repository
          SignWith: default
          EOC

      - name: Import GPG key
        env:
          APT_GPG_PRIVATE_KEY: ${{ secrets.APT_GPG_PRIVATE_KEY }}
        run: |
          echo "$APT_GPG_PRIVATE_KEY" | gpg --batch --import
          KEY_FPR=$(gpg --list-secret-keys --with-colons | awk -F: '/^fpr:/ {print $10; exit}')
          echo "GPG_KEY_FPR=$KEY_FPR" >> "$GITHUB_ENV"
          cat > ~/.gnupg/gpg-agent.conf <<EOC
          allow-loopback-pinentry
          EOC
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf

      - name: Download deb
        env:
          DEB_URL: ${{ github.event.client_payload.deb_url }}
          DEB_FILENAME: ${{ github.event.client_payload.deb_filename }}
        run: |
          curl -fL "$DEB_URL" -o "repo/incoming/$DEB_FILENAME"

      - name: Add package to apt repo
        env:
          DISTRO: stable
          COMPONENT: main
        run: |
          reprepro -b repo includedeb "$DISTRO" repo/incoming/*.deb

      - name: Export public key
        run: |
          gpg --armor --export "$GPG_KEY_FPR" > repo/public.key

      - name: Publish repository to gh-pages branch
        run: |
          rm -rf published
          mkdir -p published
          cp -R repo/dists repo/pool repo/public.key published/

      - name: Deploy to GitHub Pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: published
