name: Update APT Repository

on:
  repository_dispatch:
    types:
      - deb-published
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-apt:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4

      - name: Checkout gh-pages (existing repo data)
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: published

      - name: Install tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y reprepro gnupg dpkg-dev

      - name: Validate payload
        env:
          DEB_URL: ${{ github.event.client_payload.deb_url }}
          DEB_FILENAME: ${{ github.event.client_payload.deb_filename }}
        run: |
          test -n "$DEB_URL"
          test -n "$DEB_FILENAME"

      - name: Prepare working repo from published content
        run: |
          mkdir -p repo/conf repo/incoming
          if [ -d published/dists ]; then
            cp -R published/dists repo/
          fi
          if [ -d published/pool ]; then
            cp -R published/pool repo/
          fi

      - name: Write reprepro distributions config
        run: |
          cat > repo/conf/distributions <<'EOC'
          Origin: JKLabs
          Label: JKLabs APT
          Suite: stable
          Codename: stable
          Architectures: amd64
          Components: main
          Description: JKLabs Debian Repository
          SignWith: default
          EOC

      - name: Import signing key
        env:
          APT_GPG_PRIVATE_KEY: ${{ secrets.APT_GPG_PRIVATE_KEY }}
        run: |
          test -n "$APT_GPG_PRIVATE_KEY"
          echo "$APT_GPG_PRIVATE_KEY" | gpg --batch --import
          KEY_FPR=$(gpg --list-secret-keys --with-colons | awk -F: '/^fpr:/ {print $10; exit}')
          if [ -z "$KEY_FPR" ]; then
            echo "No GPG fingerprint found after import"
            exit 1
          fi
          echo "GPG_KEY_FPR=$KEY_FPR" >> "$GITHUB_ENV"

      - name: Download .deb
        env:
          DEB_URL: ${{ github.event.client_payload.deb_url }}
          DEB_FILENAME: ${{ github.event.client_payload.deb_filename }}
        run: |
          curl -fL "$DEB_URL" -o "repo/incoming/$DEB_FILENAME"

      - name: Include package (idempotent)
        run: |
          DEB_PATH=$(ls -1 repo/incoming/*.deb | head -n 1)
          PKG_NAME=$(dpkg-deb -f "$DEB_PATH" Package)
          PKG_VERSION=$(dpkg-deb -f "$DEB_PATH" Version)

          if reprepro -b repo list stable "$PKG_NAME" 2>/dev/null | grep -F " $PKG_VERSION" >/dev/null; then
            echo "Package $PKG_NAME version $PKG_VERSION already present. Skipping include."
          else
            reprepro -b repo includedeb stable "$DEB_PATH"
          fi

      - name: Export public key
        run: |
          gpg --armor --export "$GPG_KEY_FPR" > repo/public.key

      - name: Build publish directory
        run: |
          rm -rf publish
          mkdir -p publish
          cp -R repo/dists repo/pool repo/public.key publish/
          cp index.html publish/

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: publish


